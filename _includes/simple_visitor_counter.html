{% comment %}
  ê°„ë‹¨í•œ ë°©ë¬¸ì ì¹´ìš´í„° (ì„œë²„ë¦¬ìŠ¤ í•¨ìˆ˜ ì—†ìŒ)
  ì‚¬ìš©ë²•: {% include simple_visitor_counter.html %}
{% endcomment %}

<div class="visitor-counter">
  <div class="counter-bg-left"></div>
  <div class="counter-bg-right"></div>
  <div class="counter-text">
    <span class="counter-label">hits</span>
    <span class="counter-numbers">
      <span id="today-visitors">0</span> / <span id="total-visitors">0</span>
    </span>
  </div>
</div>

<script>
// GA4 ì„¤ì •
const GA4_CONFIG = {
  measurementId: '{{ site.analytics.google.id }}',
  propertyId: '{{ site.analytics.google.property_id }}',
  account: '{{ site.analytics.google.account }}'
};

// ë””ë²„ê¹…ì„ ìœ„í•œ ìƒì„¸ ë¡œê·¸
function debugLog(message, type = 'info') {
  const timestamp = new Date().toLocaleTimeString();
  const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'ğŸ”';
  console.log(`${prefix} [${timestamp}] ${message}`);
}

// ê°„ë‹¨í•œ ë°©ë¬¸ì ì¹´ìš´í„° (ì„œë²„ë¦¬ìŠ¤ í•¨ìˆ˜ ì—†ìŒ)
async function loadSimpleVisitorStats() {
  try {
    debugLog('ë°©ë¬¸ì í†µê³„ ë¡œë“œ ì‹œì‘');
    debugLog(`GA4 ì„¤ì •: ${JSON.stringify(GA4_CONFIG)}`);
    
    // ì„¤ì • í™•ì¸
    if (!GA4_CONFIG.propertyId) {
      throw new Error('GA4 Property IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    }
    
    // GA4 ì´ë²¤íŠ¸ ê¸°ë°˜ í†µê³„ ë¡œë“œ
    await loadGA4EventBasedStats();
    
  } catch (error) {
    debugLog(`ë°©ë¬¸ì í†µê³„ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
    displayDefaultData();
  }
}

// GA4 ì´ë²¤íŠ¸ ê¸°ë°˜ í†µê³„ (gtag ì‚¬ìš©)
async function loadGA4EventBasedStats() {
  try {
    debugLog('GA4 ì´ë²¤íŠ¸ ê¸°ë°˜ í†µê³„ ë¡œë“œ ì‹œì‘');
    
    // gtagê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
    if (typeof gtag === 'undefined') {
      debugLog('gtagê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ëŒ€ê¸° ì¤‘...');
      await waitForGtag();
    }
    
    // GA4 ì´ë²¤íŠ¸ ì „ì†¡ (í˜ì´ì§€ë·° ì¶”ì )
    gtag('event', 'page_view', {
      page_title: document.title,
      page_location: window.location.href,
      custom_parameter: 'visitor_counter'
    });
    
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë°©ë¬¸ì í†µê³„ ê°€ì ¸ì˜¤ê¸°
    const visitorStats = getVisitorStatsFromStorage();
    
    // ë°©ë¬¸ì í†µê³„ í‘œì‹œ
    displayVisitorStats(visitorStats);
    
    // ìƒˆë¡œìš´ ë°©ë¬¸ì ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
    addNewVisitorIfNeeded();
    
  } catch (error) {
    debugLog(`GA4 ì´ë²¤íŠ¸ ê¸°ë°˜ í†µê³„ ì‹¤íŒ¨: ${error.message}`, 'error');
    throw error;
  }
}

// gtag ë¡œë“œ ëŒ€ê¸°
function waitForGtag() {
  return new Promise((resolve) => {
    if (typeof gtag !== 'undefined') {
      resolve();
      return;
    }
    
    const checkInterval = setInterval(() => {
      if (typeof gtag !== 'undefined') {
        clearInterval(checkInterval);
        resolve();
      }
    }, 100);
    
    // ìµœëŒ€ 5ì´ˆ ëŒ€ê¸°
    setTimeout(() => {
      clearInterval(checkInterval);
      resolve();
    }, 5000);
  });
}

// ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë°©ë¬¸ì í†µê³„ ê°€ì ¸ì˜¤ê¸°
function getVisitorStatsFromStorage() {
  const today = new Date().toDateString();
  const storageKey = 'visitor_stats';
  
  let stats = JSON.parse(localStorage.getItem(storageKey) || '{}');
  
  // ì˜¤ëŠ˜ ë‚ ì§œê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
  if (!stats[today]) {
    stats[today] = {
      total_visitors: 0,
      today_visitors: 0,
      total_pageviews: 0,
      last_visit: null,
      session_id: generateSessionId()
    };
  }
  
  return stats;
}

// ì„¸ì…˜ ID ìƒì„±
function generateSessionId() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

// ìƒˆë¡œìš´ ë°©ë¬¸ì ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
function addNewVisitorIfNeeded() {
  const today = new Date().toDateString();
  const storageKey = 'visitor_stats';
  
  let stats = getVisitorStatsFromStorage();
  const now = new Date();
  const currentSessionId = stats[today].session_id;
  
  // ì„¸ì…˜ì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸ (ìƒˆë¡œìš´ ë¸Œë¼ìš°ì € ì„¸ì…˜)
  const isNewSession = !sessionStorage.getItem('visitor_session_id') || 
                      sessionStorage.getItem('visitor_session_id') !== currentSessionId;
  
  if (isNewSession) {
    // ìƒˆë¡œìš´ ì„¸ì…˜ ì‹œì‘
    sessionStorage.setItem('visitor_session_id', currentSessionId);
    
    // ì˜¤ëŠ˜ ì²« ë°©ë¬¸ì¸ì§€ í™•ì¸ (24ì‹œê°„ ê¸°ì¤€)
    const lastVisit = stats[today].last_visit ? new Date(stats[today].last_visit) : null;
    const isFirstVisitToday = !lastVisit || 
                             lastVisit.toDateString() !== today ||
                             (now - lastVisit) > (24 * 60 * 60 * 1000); // 24ì‹œê°„
    
    if (isFirstVisitToday) {
      stats[today].today_visitors++;
      stats[today].total_visitors++;
      debugLog('ìƒˆë¡œìš´ ë°©ë¬¸ì ì¶”ê°€ë¨ (24ì‹œê°„ ê¸°ì¤€)', 'success');
    }
    
    // í˜ì´ì§€ë·°ëŠ” ì„¸ì…˜ë‹¹ 1íšŒë§Œ ì¦ê°€
    stats[today].total_pageviews++;
    debugLog('ìƒˆë¡œìš´ ì„¸ì…˜: í˜ì´ì§€ë·° ì¦ê°€', 'success');
  } else {
    // ê°™ì€ ì„¸ì…˜ì—ì„œëŠ” í˜ì´ì§€ë·° ì¦ê°€í•˜ì§€ ì•ŠìŒ
    debugLog('ê°™ì€ ì„¸ì…˜: í˜ì´ì§€ë·° ì¦ê°€í•˜ì§€ ì•ŠìŒ', 'info');
  }
  
  stats[today].last_visit = now.toISOString();
  
  // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
  localStorage.setItem(storageKey, JSON.stringify(stats));
  
  // í™”ë©´ ì—…ë°ì´íŠ¸
  displayVisitorStats(stats);
  
  debugLog(`ë°©ë¬¸ì í†µê³„ ì—…ë°ì´íŠ¸: ${JSON.stringify(stats[today])}`, 'success');
}

// ë°©ë¬¸ì í†µê³„ í‘œì‹œ
function displayVisitorStats(stats) {
  const today = new Date().toDateString();
  const todayStats = stats[today] || { total_visitors: 0, today_visitors: 0, total_pageviews: 0 };
  
  document.getElementById('today-visitors').textContent = todayStats.today_visitors;
  document.getElementById('total-visitors').textContent = todayStats.total_visitors;
  
  const counter = document.querySelector('.visitor-counter');
  if (counter) {
    counter.style.opacity = '1';
    counter.title = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleString('ko-KR')} (ë¡œì»¬ í†µê³„)`;
  }
  
  debugLog('ë°©ë¬¸ì í†µê³„ í‘œì‹œ ì™„ë£Œ', 'success');
}

// ê¸°ë³¸ ë°ì´í„° í‘œì‹œ (API ì‹¤íŒ¨ ì‹œ)
function displayDefaultData() {
  document.getElementById('today-visitors').textContent = '0';
  document.getElementById('total-visitors').textContent = '0';
  
  const counter = document.querySelector('.visitor-counter');
  if (counter) {
    counter.style.opacity = '0.6';
    counter.title = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
  }
  
  debugLog('ê¸°ë³¸ í‘œì‹œ ëª¨ë“œë¡œ ì „í™˜', 'error');
}

// í˜ì´ì§€ ë¡œë“œ í›„ ì‹¤í–‰
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', loadSimpleVisitorStats);
} else {
  loadSimpleVisitorStats();
}

// 5ë¶„ë§ˆë‹¤ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
setInterval(loadSimpleVisitorStats, 5 * 60 * 1000);

// ë¡œë”© ìƒíƒœ í‘œì‹œ
function showLoadingState() {
  document.getElementById('today-visitors').textContent = 'ë¡œë”© ì¤‘...';
  document.getElementById('total-visitors').textContent = 'ë¡œë”© ì¤‘...';
  
  const counter = document.querySelector('.visitor-counter');
  if (counter) {
    counter.style.opacity = '0.8';
    counter.title = 'ë°©ë¬¸ì í†µê³„ ë¡œë”© ì¤‘...';
  }
}

// ì„±ê³µ ìƒíƒœ í‘œì‹œ
function showSuccessState() {
  const counter = document.querySelector('.visitor-counter');
  if (counter) {
    counter.style.opacity = '1';
    counter.title = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleString('ko-KR')} (ë¡œì»¬ í†µê³„)`;
  }
}

// í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ì‹œ ë°©ë¬¸ì ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
document.addEventListener('visibilitychange', function() {
  if (!document.hidden) {
    debugLog('í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½: ë°©ë¬¸ì í†µê³„ ì—…ë°ì´íŠ¸');
    addNewVisitorIfNeeded();
  }
});

// í˜ì´ì§€ í¬ì»¤ìŠ¤ ì‹œ ë°©ë¬¸ì ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
window.addEventListener('focus', function() {
  debugLog('í˜ì´ì§€ í¬ì»¤ìŠ¤: ë°©ë¬¸ì í†µê³„ ì—…ë°ì´íŠ¸');
  addNewVisitorIfNeeded();
});
</script>
