{% comment %}
  GoatCounter ë°©ë¬¸ì ì¶”ì  ë° ì¡°íšŒìˆ˜ í‘œì‹œ
{% endcomment %}

<script>
  // GoatCounter ë¡œë“œ í™•ì¸
  console.log('ğŸ” GoatCounter ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œë¨');
  
  var t = setInterval(function () {
    if (window.goatcounter && window.goatcounter.visit_count) {
      clearInterval(t)
      console.log('âœ… GoatCounter ê°ì²´ í™•ì¸ë¨');
      window.goatcounter.visit_count({ append: 'body' })
    }
  }, 100)
</script>

<script data-goatcounter="https://{{ site.goat_counter }}.goatcounter.com/count"
        data-goatcounter-settings='{"no_onload": true}'
        async src="//gc.zgo.at/count.js"></script>

<!-- í˜ì´ì§€ë³„ ì¡°íšŒìˆ˜ í‘œì‹œë¥¼ ìœ„í•œ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
  console.log('ğŸ” í˜ì´ì§€ ì¡°íšŒìˆ˜ ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘');
  
  // ì„¸ì…˜ ê¸°ë°˜ ë°©ë¬¸ì ì¶”ì 
  function trackUniqueVisit() {
    const sessionKey = 'visited_' + window.location.pathname;
    const hasVisited = sessionStorage.getItem(sessionKey);
    
    if (!hasVisited) {
      console.log('ğŸ†• ìƒˆë¡œìš´ ë°©ë¬¸ì: í˜ì´ì§€ë·° ì¶”ì  ì‹œì‘');
      // ì„¸ì…˜ì—ì„œ ë°©ë¬¸í•˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ì¹´ìš´íŒ…
      if (window.goatcounter) {
        window.goatcounter.count({
          path: window.location.pathname,
          title: document.title
        });
        console.log('âœ… GoatCounter í˜ì´ì§€ë·° ì¶”ì  ì™„ë£Œ');
      } else {
        console.log('âŒ GoatCounter ê°ì²´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
      }
      sessionStorage.setItem(sessionKey, 'true');
    } else {
      console.log('ğŸ”„ ì´ë¯¸ ë°©ë¬¸í•œ í˜ì´ì§€: ì¶”ì  ê±´ë„ˆëœ€');
    }
  }
  
  // GoatCounter APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹¤ì œ ì¡°íšŒìˆ˜ ê°€ì ¸ì˜¤ê¸°
  async function loadPageViews() {
    console.log('ğŸ” ì¡°íšŒìˆ˜ ë¡œë“œ ì‹œì‘');
    const pageviewElements = document.querySelectorAll('[data-goatcounter-url]');
    console.log(`ğŸ“Š ì¡°íšŒìˆ˜ ìš”ì†Œ ${pageviewElements.length}ê°œ ë°œê²¬`);
    
    for (const element of pageviewElements) {
      const url = element.getAttribute('data-goatcounter-url');
      // ìƒëŒ€ ê²½ë¡œë¥¼ ì ˆëŒ€ ê²½ë¡œë¡œ ë³€í™˜
      const path = url.startsWith('/') ? url : '/' + url;
      console.log(`ğŸ” ì›ë³¸ URL: ${url}`);
      console.log(`ğŸ” ì²˜ë¦¬ëœ ê²½ë¡œ: ${path}`);
      
      try {
        // GoatCounter API í˜¸ì¶œ
        const apiUrl = `https://{{ site.goat_counter }}.goatcounter.com/api/v0/stats/path?path=${encodeURIComponent(path)}`;
        console.log(`ğŸ” API í˜¸ì¶œ: ${apiUrl}`);
        
        const response = await fetch(apiUrl);
        console.log(`ğŸ” API ì‘ë‹µ ìƒíƒœ: ${response.status}`);
        
        if (response.ok) {
          const data = await response.json();
          console.log(`ğŸ” API ì‘ë‹µ ë°ì´í„°:`, data);
          
          if (data && data.stats && data.stats.length > 0) {
            const pageViews = data.stats[0].count;
            element.textContent = pageViews.toString();
            console.log(`âœ… ì‹¤ì œ ì¡°íšŒìˆ˜: ${pageViews}`);
          } else {
            element.textContent = '0';
            console.log(`ğŸ“Š ì¡°íšŒìˆ˜ ì—†ìŒ: 0ìœ¼ë¡œ ì„¤ì •`);
          }
        } else {
          element.textContent = '0';
          console.log(`âŒ API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}`);
        }
      } catch (error) {
        console.log(`âŒ API í˜¸ì¶œ ì˜¤ë¥˜:`, error);
        element.textContent = '0';
      }
      
      console.log(`ğŸ” ìµœì¢… ìš”ì†Œ í…ìŠ¤íŠ¸:`, element.textContent);
    }
  }
  
  // í˜ì´ì§€ ë¡œë“œ í›„ ì‹¤í–‰
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸ“„ DOM ë¡œë“œ ì™„ë£Œ');
      trackUniqueVisit();
      loadPageViews();
    });
  } else {
    console.log('ğŸ“„ DOM ì´ë¯¸ ë¡œë“œë¨');
    trackUniqueVisit();
    loadPageViews();
  }
</script>

<noscript>
  <img src="https://{{ site.goat_counter }}.goatcounter.com/count?p=/test-img">
</noscript>