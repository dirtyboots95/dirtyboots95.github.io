{% comment %}
  Google Analytics ë°©ë¬¸ì í†µê³„ ì¹´ìš´í„°
  ì‚¬ìš©ë²•: {% include visitor_counter.html %}
{% endcomment %}

<div class="visitor-counter">
  <div class="counter-item">
    <span class="counter-label">ğŸ“Š ì´ ë°©ë¬¸ì</span>
    <span class="counter-value" id="total-visitors">ë¡œë”© ì¤‘...</span>
  </div>
  <div class="counter-item">
    <span class="counter-label">ğŸ‘¥ ì˜¤ëŠ˜ ë°©ë¬¸ì</span>
    <span class="counter-value" id="today-visitors">ë¡œë”© ì¤‘...</span>
  </div>
  <div class="counter-item">
    <span class="counter-label">ğŸ“ˆ ì´ í˜ì´ì§€ë·°</span>
    <span class="counter-value" id="total-pageviews">ë¡œë”© ì¤‘...</span>
  </div>
</div>

<script>
// ë°©ë¬¸ì í†µê³„ ë¡œë“œ í•¨ìˆ˜
async function loadVisitorStats() {
  try {
    // Google Analytics 4 ë°ì´í„° ë¡œë“œ ì‹œë„
    await loadGA4Data();
  } catch (error) {
    console.error('GA4 API í˜¸ì¶œ ì‹¤íŒ¨:', error);
    // ì—ëŸ¬ ì‹œ ê¸°ë³¸ í‘œì‹œ
    displayErrorData();
  }
}

// ì—ëŸ¬ ë°ì´í„° í‘œì‹œ
function displayErrorData() {
  document.getElementById('total-visitors').textContent = 'ğŸ“Š';
  document.getElementById('today-visitors').textContent = 'ğŸ“Š';
  document.getElementById('total-pageviews').textContent = 'ğŸ“Š';
  
  // ì—ëŸ¬ ìƒíƒœ í‘œì‹œ
  const counter = document.querySelector('.visitor-counter');
  if (counter) {
    counter.style.opacity = '0.6';
    counter.title = 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ - ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”';
  }
}

// Google Analytics 4 ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
async function loadGA4Data() {
  const propertyId = '{{ site.analytics.google.property_id }}';
  
  // ë¡œì»¬ í™˜ê²½ì—ì„œëŠ” ë¡œì»¬ API ì„œë²„ ì‚¬ìš©
  const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
  const apiBaseUrl = isLocal ? 'http://localhost:3001' : '';
  
  try {
    // ë°©ë²• 1: ì„œë²„ë¦¬ìŠ¤ í•¨ìˆ˜ í˜¸ì¶œ (ê¶Œì¥)
    const response = await fetch(`${apiBaseUrl}/api/ga4-analytics?property_id=${propertyId}`);
    if (response.ok) {
      const data = await response.json();
      document.getElementById('total-visitors').textContent = data.total_visitors.toLocaleString();
      document.getElementById('today-visitors').textContent = data.today_visitors.toLocaleString();
      document.getElementById('total-pageviews').textContent = data.total_pageviews.toLocaleString();
      
      // ì„±ê³µ ìƒíƒœ í‘œì‹œ
      const counter = document.querySelector('.visitor-counter');
      if (counter) {
        counter.style.opacity = '1';
        const source = isLocal ? 'ë¡œì»¬ í…ŒìŠ¤íŠ¸' : 'GA4 API';
        counter.title = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleString('ko-KR')} (${source})`;
      }
      return;
    }
    
    // ë°©ë²• 2: Google Analytics Embed API (í´ë°±)
    if (typeof gapi !== 'undefined' && gapi.analytics) {
      await loadGA4EmbedAPI();
    } else {
      // Embed API ë¡œë“œ ì‹œë„
      await loadGoogleAnalyticsEmbedAPI();
    }
    
  } catch (error) {
    console.error('GA4 API í˜¸ì¶œ ì‹¤íŒ¨:', error);
    // ì—ëŸ¬ ì‹œ í´ë°± ë°©ë²• ì‹œë„
    try {
      await loadGA4EmbedAPI();
    } catch (fallbackError) {
      console.error('í´ë°± ë°©ë²•ë„ ì‹¤íŒ¨:', fallbackError);
      displayErrorData();
    }
  }
}

// Google Analytics Embed API ì‚¬ìš© (í´ë°±)
async function loadGA4EmbedAPI() {
  return new Promise((resolve, reject) => {
    if (typeof gapi === 'undefined' || !gapi.analytics) {
      reject(new Error('Google Analytics Embed APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'));
      return;
    }

    gapi.analytics.ready(function() {
      try {
        // ì´ ë°©ë¬¸ì ìˆ˜ (30ì¼)
        var totalVisitorsQuery = new gapi.analytics.report.Data({
          query: {
            metrics: 'ga:users',
            'start-date': '30daysAgo',
            'end-date': 'today'
          }
        });
        
        // ì˜¤ëŠ˜ ë°©ë¬¸ì ìˆ˜
        var todayVisitorsQuery = new gapi.analytics.report.Data({
          query: {
            metrics: 'ga:users',
            'start-date': 'today',
            'end-date': 'today'
          }
        });
        
        // ì´ í˜ì´ì§€ë·° (30ì¼)
        var totalPageviewsQuery = new gapi.analytics.report.Data({
          query: {
            metrics: 'ga:pageviews',
            'start-date': '30daysAgo',
            'end-date': 'today'
          }
        });
        
        let completedQueries = 0;
        const totalQueries = 3;
        
        // ì¿¼ë¦¬ ì™„ë£Œ ì²˜ë¦¬
        function handleQueryComplete() {
          completedQueries++;
          if (completedQueries === totalQueries) {
            resolve();
          }
        }
        
        // ì´ ë°©ë¬¸ì ìˆ˜ ì¿¼ë¦¬ ì‹¤í–‰
        totalVisitorsQuery.execute(function(response) {
          if (response.totalsForAllResults) {
            const totalVisitors = response.totalsForAllResults['ga:users'];
            document.getElementById('total-visitors').textContent = parseInt(totalVisitors).toLocaleString();
          }
          handleQueryComplete();
        });
        
        // ì˜¤ëŠ˜ ë°©ë¬¸ì ìˆ˜ ì¿¼ë¦¬ ì‹¤í–‰
        todayVisitorsQuery.execute(function(response) {
          if (response.totalsForAllResults) {
            const todayVisitors = response.totalsForAllResults['ga:users'];
            document.getElementById('today-visitors').textContent = parseInt(todayVisitors).toLocaleString();
          }
          handleQueryComplete();
        });
        
        // ì´ í˜ì´ì§€ë·° ì¿¼ë¦¬ ì‹¤í–‰
        totalPageviewsQuery.execute(function(response) {
          if (response.totalsForAllResults) {
            const totalPageviews = response.totalsForAllResults['ga:pageviews'];
            document.getElementById('total-pageviews').textContent = parseInt(totalPageviews).toLocaleString();
          }
          handleQueryComplete();
        });
        
      } catch (error) {
        reject(error);
      }
    });
  });
}

// Google Analytics Embed API ë¡œë“œ í•¨ìˆ˜
function loadGoogleAnalyticsEmbedAPI() {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = 'https://apis.google.com/js/platform.js';
    script.onload = function() {
      gapi.load('analytics', function() {
        resolve();
      });
    };
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

// í˜ì´ì§€ ë¡œë“œ í›„ í†µê³„ ë¡œë“œ
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', loadVisitorStats);
} else {
  loadVisitorStats();
}

// 5ë¶„ë§ˆë‹¤ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
setInterval(loadVisitorStats, 5 * 60 * 1000);
</script>
