{% comment %}
  Google Analytics ë°©ë¬¸ì í†µê³„ ì¹´ìš´í„°
  ì‚¬ìš©ë²•: {% include visitor_counter.html %}
{% endcomment %}

{% if site.analytics.google.id and jekyll.environment == "production" %}
<div class="visitor-counter">
  <div class="counter-item">
    <span class="counter-label">ğŸ“Š ì´ ë°©ë¬¸ì</span>
    <span class="counter-value" id="total-visitors">ë¡œë”© ì¤‘...</span>
  </div>
  <div class="counter-item">
    <span class="counter-label">ğŸ‘¥ ì˜¤ëŠ˜ ë°©ë¬¸ì</span>
    <span class="counter-value" id="today-visitors">ë¡œë”© ì¤‘...</span>
  </div>
  <div class="counter-item">
    <span class="counter-label">ğŸ“ˆ ì´ í˜ì´ì§€ë·°</span>
    <span class="counter-value" id="total-pageviews">ë¡œë”© ì¤‘...</span>
  </div>
</div>

<script>
// Google Analytics ë°©ë¬¸ì í†µê³„ ê°€ì ¸ì˜¤ê¸°
async function loadVisitorStats() {
  const measurementId = '{{ site.analytics.google.id }}';
  
  try {
    // Google Analytics Data API v1ì„ ì‚¬ìš©í•˜ì—¬ í†µê³„ ê°€ì ¸ì˜¤ê¸°
    // ì°¸ê³ : ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì„œë²„ ì‚¬ì´ë“œì—ì„œ ì²˜ë¦¬í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤
    
    // Google Analytics Embed APIë¥¼ ì‚¬ìš©í•œ ì‹¤ì œ ë°ì´í„° ì—°ë™
    try {
      // Google Analytics Embed API ë¡œë“œ
      if (typeof gapi !== 'undefined' && gapi.analytics) {
        loadGA4Data();
      } else {
        // Embed APIê°€ ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš° ì„ì‹œ ë°ì´í„° í‘œì‹œ
        document.getElementById('total-visitors').textContent = 'ğŸ“Š';
        document.getElementById('today-visitors').textContent = 'ğŸ“Š';
        document.getElementById('total-pageviews').textContent = 'ğŸ“Š';
      }
    } catch (error) {
      console.error('GA4 API í˜¸ì¶œ ì‹¤íŒ¨:', error);
      document.getElementById('total-visitors').textContent = 'ğŸ“Š';
      document.getElementById('today-visitors').textContent = 'ğŸ“Š';
      document.getElementById('total-pageviews').textContent = 'ğŸ“Š';
    }
    
  } catch (error) {
    console.error('ë°©ë¬¸ì í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
    document.getElementById('total-visitors').textContent = 'ğŸ“Š';
    document.getElementById('today-visitors').textContent = 'ğŸ“Š';
    document.getElementById('total-pageviews').textContent = 'ğŸ“Š';
  }
}

// Google Analytics 4 ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ (Data API v1 ì‚¬ìš©)
async function loadGA4Data() {
  const propertyId = '{{ site.analytics.google.property_id }}';
  
  try {
    // Google Analytics Data API v1ì„ ì‚¬ìš©í•œ ì‹¤ì œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    // ì°¸ê³ : CORS ì´ìŠˆë¡œ ì¸í•´ ì„œë²„ ì‚¬ì´ë“œì—ì„œ ì²˜ë¦¬í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤
    
    // ë°©ë²• 1: ì„œë²„ë¦¬ìŠ¤ í•¨ìˆ˜ í˜¸ì¶œ (ê¶Œì¥)
    const response = await fetch(`/api/ga4-analytics?property_id=${propertyId}`);
    if (response.ok) {
      const data = await response.json();
      document.getElementById('total-visitors').textContent = data.total_visitors.toLocaleString();
      document.getElementById('today-visitors').textContent = data.today_visitors.toLocaleString();
      document.getElementById('total-pageviews').textContent = data.total_pageviews.toLocaleString();
      return;
    }
    
    // ë°©ë²• 2: Google Analytics Embed API (í´ë°±)
    if (typeof gapi !== 'undefined' && gapi.analytics) {
      loadGA4EmbedAPI();
    } else {
      // Embed API ë¡œë“œ ì‹œë„
      loadGoogleAnalyticsEmbedAPI();
    }
    
  } catch (error) {
    console.error('GA4 API í˜¸ì¶œ ì‹¤íŒ¨:', error);
    // ì—ëŸ¬ ì‹œ ê¸°ë³¸ í‘œì‹œ
    document.getElementById('total-visitors').textContent = 'ğŸ“Š';
    document.getElementById('today-visitors').textContent = 'ğŸ“Š';
    document.getElementById('total-pageviews').textContent = 'ğŸ“Š';
  }
}

// Google Analytics Embed API ì‚¬ìš© (í´ë°±)
function loadGA4EmbedAPI() {
  gapi.analytics.ready(function() {
    // ì´ ë°©ë¬¸ì ìˆ˜ (30ì¼)
    var totalVisitorsQuery = new gapi.analytics.report.Data({
      query: {
        metrics: 'ga:users',
        'start-date': '30daysAgo',
        'end-date': 'today'
      }
    });
    
    // ì˜¤ëŠ˜ ë°©ë¬¸ì ìˆ˜
    var todayVisitorsQuery = new gapi.analytics.report.Data({
      query: {
        metrics: 'ga:users',
        'start-date': 'today',
        'end-date': 'today'
      }
    });
    
    // ì´ í˜ì´ì§€ë·° (30ì¼)
    var totalPageviewsQuery = new gapi.analytics.report.Data({
      query: {
        metrics: 'ga:pageviews',
        'start-date': '30daysAgo',
        'end-date': 'today'
      }
    });
    
    // ì¿¼ë¦¬ ì‹¤í–‰ ë° ê²°ê³¼ í‘œì‹œ
    totalVisitorsQuery.execute(function(response) {
      if (response.totalsForAllResults) {
        const totalVisitors = response.totalsForAllResults['ga:users'];
        document.getElementById('total-visitors').textContent = parseInt(totalVisitors).toLocaleString();
      }
    });
    
    todayVisitorsQuery.execute(function(response) {
      if (response.totalsForAllResults) {
        const todayVisitors = response.totalsForAllResults['ga:users'];
        document.getElementById('today-visitors').textContent = parseInt(todayVisitors).toLocaleString();
      }
    });
    
    totalPageviewsQuery.execute(function(response) {
      if (response.totalsForAllResults) {
        const totalPageviews = response.totalsForAllResults['ga:pageviews'];
        document.getElementById('total-pageviews').textContent = parseInt(totalPageviews).toLocaleString();
      }
    });
  });
}

// Google Analytics Embed API ë¡œë“œ í•¨ìˆ˜
function loadGoogleAnalyticsEmbedAPI() {
  const script = document.createElement('script');
  script.src = 'https://apis.google.com/js/platform.js';
  script.onload = function() {
    gapi.load('analytics', function() {
      loadGA4EmbedAPI();
    });
  };
  document.head.appendChild(script);
}

// í˜ì´ì§€ ë¡œë“œ í›„ í†µê³„ ë¡œë“œ
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', loadVisitorStats);
} else {
  loadVisitorStats();
}
</script>
{% endif %}
